@{
    ViewData["Title"] = "Admin Dashboard";
}

<h2 class="text-center">Admin Dashboard</h2>

<div class="container mt-3">
    <div id="userTable"></div>
</div>

@section Scripts {
    <script src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">

    <script>
        $(document).ready(function () {
            var table = new Tabulator("#userTable", {
                layout: "fitColumns",
                ajaxURL: "/Admin/GetUsers",
                columns: [
                    { title: "ID", field: "id", visible: false },
                    { title: "Username", field: "username", sorter: "string" },
                    { title: "Email", field: "email", sorter: "string" },
                    { title: "Admin", field: "isAdmin", formatter: "tickCross" },
                    {
                        title: "Blocked",
                        field: "isBlocked",
                        formatter: function (cell) {
                            return cell.getValue() ? "Blocked" : "Active";
                        }
                    },
                    {
                        title: "Actions",
                        formatter: function (cell, formatterParams, onRendered) {
                            var userId = cell.getRow().getData().id;
                            var isBlocked = cell.getRow().getData().isBlocked;
                            var isAdmin = cell.getRow().getData().isAdmin;
                            return `
                                <button class="btn btn-warning btn-sm" onclick="toggleBlock(${userId})">
                                    ${isBlocked ? 'Unblock' : 'Block'}
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${userId})">Delete</button>
                                <button class="btn btn-info btn-sm" onclick="toggleAdminStatus(${userId}, ${isAdmin})">
                                    ${isAdmin ? 'Admin' : 'User'}
                                </button>
                            `;
                        }
                    }
                ]
            });

            window.toggleBlock = function (userId) {
                $.post('/Admin/ToggleBlockUser', { userId: userId }, function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        table.replaceData("/Admin/GetUsers");
                    } else {
                        toastr.error(response.message);
                    }
                });
            };

            window.deleteUser = function (userId) {
                if (confirm("Are you sure you want to delete this user?")) {
                    $.post('/Admin/DeleteUser', { userId: userId }, function (response) {
                        if (response.success) {
                            toastr.success(response.message);
                            table.replaceData("/Admin/GetUsers");
                        } else {
                            toastr.error(response.message);
                        }
                    });
                }
            };

            // Toggle Admin Status
            window.toggleAdminStatus = function (userId, isAdmin) {
                $.post('/Admin/ToggleAdminStatus', { userId: userId }, function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        table.replaceData("/Admin/GetUsers");
                    } else {
                        toastr.error(response.message);
                    }
                });
            };
        });
    </script>
}
