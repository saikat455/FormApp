@{
    ViewData["Title"] = "Profile";
}

<div class="container mt-4">
    <h2>My Profile</h2>

    <!-- Tab navigation for Templates and Forms -->
    <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                My Templates
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms" type="button" role="tab">
                Submitted Forms
            </button>
        </li>
    </ul>

    <div class="tab-content" id="profileTabsContent">
        <div class="tab-pane fade show active" id="templates" role="tabpanel">
            <div class="d-flex justify-content-end my-3">
                <button class="btn btn-primary" onclick="showCreateTemplateModal()">
                    <i class="bi bi-plus-circle"></i> Create
                </button>
            </div>


            <!-- Template Table -->
            <div id="templateTable"></div>
        </div>

        <div class="tab-pane fade" id="forms" role="tabpanel">
            <div id="formTable"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="templateModalTitle">Create Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <input type="hidden" id="templateId">
                    <!-- Template Details Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">Template Details</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Topic <span class="text-danger">*</span></label>
                                <select class="form-control" id="topic" required>
                                    <option value="Education">Education</option>
                                    <option value="Quiz">Quiz</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" rows="3" required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="imageUrl">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4 pt-2">
                                    <input class="form-check-input" type="checkbox" id="isPublic">
                                    <label class="form-check-label">Public Template</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Question Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">Questions</h5>
                        <div id="questionsList" class="mb-3"></div>
                        <div class="d-flex align-items-center text-muted " onclick="addQuestion()" style="gap: 10px; cursor: pointer;">
                            <div class="p-3 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; background-color: #f0f0f0; border-radius: 8px;">
                                <i class="bi bi-plus" style="font-size: 1.5rem; color: #6c757d;"></i>
                            </div>
                            <span class="fw-medium" style="color: #6c757d;">Add Question</span>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>
</div>

<!-- View Template Questions Modal -->
<div class="modal fade" id="viewQuestionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewQuestionsModalTitle">Template Questions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewQuestionsContainer">
                <!-- Questions will be dynamically loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let templateTable;
        let formTable;

        $(document).ready(function() {
            initializeTables();
        });

        function initializeTables() {
            const isAdmin = document.querySelector('.container').dataset.isAdmin === 'true';

            templateTable = new Tabulator("#templateTable", {
                ajaxURL: "/User/GetTemplates",
                layout: "fitColumns",
                columns: [
                    { title: "Title", field: "title", sorter: "string" },
                    { title: "Topic", field: "topic", sorter: "string" },
                    { title: "Public", field: "isPublic", formatter: "tickCross" },
                    ...(isAdmin ? [{ title: "Created By", field: "createdBy", sorter: "string" }] : []),
                    {
                        title: "Actions",
                        formatter: function(cell) {
                            const data = cell.getRow().getData();
                            return `
                                <button class="btn btn-info btn-sm" onclick="viewTemplateQuestions(${data.id})">View Questions</button>
                                 <button class="btn btn-info btn-sm" onclick="editTemplate(${data.id})"><i class="bi bi-pen"></i></button>
                                 <button class="btn btn-danger btn-sm" onclick="deleteTemplate(${data.id})"><i class="bi bi-trash3"></i></button>
                            `;
                        }
                    }
                ]
            });
            
            formTable = new Tabulator("#formTable", {
                ajaxURL: "/Admin/GetFormAnswers", // Endpoint to get data
                ajaxResponse: function(url, params, response) {
                    console.log("Tabulator received data:", response);  // Check data structure here
                    return response;  // Make sure we return the data to be displayed in the table
                },
                layout: "fitColumns",
                columns: [
                    { title: "Template Title", field: "templateTitle", headerFilter: "input", sorter: "string" },
                                     { title: "User", field: "username", headerFilter: "input", sorter: "string" },
                    { title: "Question Title", field: "questionTitle", headerFilter: "input", sorter: "string" },
                    { title: "Answer", field: "answer", headerFilter: "input", sorter: "string" }
                ]
            });
        }

        // Rest of your JavaScript functions remain the same

        function showCreateTemplateModal() {
            $('#templateId').val('');
            $('#templateForm')[0].reset();
            $('#questionsList').empty();
            $('#templateModalTitle').text('Create Template');
            $('#templateModal').modal('show');
        }


        function addQuestion() {
            const questionHtml = `
                <div class="question-item card mb-3 border-grey">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0" style="color: #495057;">New Question</h6>
                            <button type="button" class="btn btn-sm btn-link text-danger" onclick="this.closest('.question-item').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" style="color: #6c757d;">Question Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control question-title" required style="border-color: #dee2e6;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" style="color: #6c757d;">Type <span class="text-danger">*</span></label>
                                <select class="form-control question-type" required style="border-color: #dee2e6;">
                                    <option value="SingleLine">Single Line Text</option>
                                    <option value="MultiLine">Multi Line Text</option>
                                    <option value="Integer">Integer</option>
                                      <option value="Radio">Radio</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label" style="color: #6c757d;">Description</label>
                                <input type="text" class="form-control question-description" style="border-color: #dee2e6;">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input question-show-table" style="border-color: #dee2e6;">
                                    <label class="form-check-label" style="color: #6c757d;">Show in Table</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#questionsList').append(questionHtml);
        }

        // function addQuestion() {
        //     const questionHtml = `
        //         <div class="question-item card mb-3 border-grey">
        //             <div class="card-body">
        //                 <div class="d-flex justify-content-between align-items-center mb-3">
        //                     <h6 class="card-title mb-0" style="color: #495057;">New Question</h6>
        //                     <button type="button" class="btn btn-sm btn-link text-danger" onclick="this.closest('.question-item').remove()">
        //                         <i class="bi bi-trash"></i>
        //                     </button>
        //                 </div>
        //                 <div class="row g-3">
        //                     <div class="col-md-6">
        //                         <label class="form-label" style="color: #6c757d;">Question Title <span class="text-danger">*</span></label>
        //                         <input type="text" class="form-control question-title" required style="border-color: #dee2e6;">
        //                     </div>
        //                     <div class="col-md-6">
        //                         <label class="form-label" style="color: #6c757d;">Type <span class="text-danger">*</span></label>
        //                         <select class="form-control question-type" required style="border-color: #dee2e6;" onchange="toggleCheckboxOptions(this)">
        //                             <option value="SingleLine">Single Line Text</option>
        //                             <option value="MultiLine">Multi Line Text</option>
        //                             <option value="Integer">Integer</option>
        //                             <option value="Checkbox">Checkbox</option>
        //                             <option value="Radio">Radio</option>
        //                         </select>
        //                     </div>
        //                     <div class="col-12">
        //                         <label class="form-label" style="color: #6c757d;">Description</label>
        //                         <input type="text" class="form-control question-description" style="border-color: #dee2e6;">
        //                     </div>
        //                     <div class="col-12">
        //                         <div class="form-check">
        //                             <input type="checkbox" class="form-check-input question-show-table" style="border-color: #dee2e6;">
        //                             <label class="form-check-label" style="color: #6c757d;">Show in Table</label>
        //                         </div>
        //                     </div>

        //                     <!-- Dynamic checkbox options will be appended here -->
        //                     <div class="col-12 checkbox-options-container" style="display: none;">
        //                         <label class="form-label" style="color: #6c757d;">Multiple Choice Options</label>
        //                         <div class="checkbox-options-list">
        //                             <div class="input-group mb-2">
        //                                 <input type="text" class="form-control checkbox-option" placeholder="Option 1" style="border-color: #dee2e6;">
        //                                 <button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeOption(this)">-</button>
        //                             </div>
        //                         </div>
        //                         <button type="button" class="btn btn-sm btn-primary" onclick="addCheckboxOption(this)">+</button>
        //                     </div>
        //                 </div>
        //             </div>
        //         </div>
        //     `;
        //     $('#questionsList').append(questionHtml);
        // }

        // Toggle the visibility of the options for Checkbox type
        function toggleCheckboxOptions(selectElement) {
            const checkboxOptionsContainer = $(selectElement).closest('.question-item').find('.checkbox-options-container');

            if (selectElement.value === 'Checkbox') {
                checkboxOptionsContainer.show();
            } else {
                checkboxOptionsContainer.hide();
                // Remove all added options if the type is changed
                checkboxOptionsContainer.find('.checkbox-options-list').empty();
            }
        }

        // Add a new input box for checkbox option
        function addCheckboxOption(button) {
            const newOptionHtml = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control checkbox-option" placeholder="Option" style="border-color: #dee2e6;">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeOption(this)">-</button>
                </div>
            `;
            $(button).prev('.checkbox-options-list').append(newOptionHtml);
        }

        // Remove a checkbox option input box
        function removeOption(button) {
            $(button).closest('.input-group').remove();
        }



        function saveTemplate() {
            // Validate required fields
            const requiredFields = [
                { selector: '#title', message: 'Title is required' },
                { selector: '#topic', message: 'Topic is required' },
                { selector: '#description', message: 'Description is required' }
            ];

            let isValid = true;
            requiredFields.forEach(field => {
                const value = $(field.selector).val().trim();
                if (!value) {
                    toastr.error(field.message);
                    isValid = false;
                }
            });

            // Validate questions
            const questions = [];
            $('.question-item').each(function() {
                const questionTitle = $(this).find('.question-title').val().trim();
                const questionType = $(this).find('.question-type').val().trim();

                if (!questionTitle) {
                    toastr.error('Question title is required for all questions');
                    isValid = false;
                }

                if (!questionType) {
                    toastr.error('Question type is required for all questions');
                    isValid = false;
                }

                questions.push({
                    title: questionTitle,
                    description: $(this).find('.question-description').val().trim(),
                    type: questionType,
                    showInTable: $(this).find('.question-show-table').is(':checked')
                });
            });

            // If validation fails, stop the function
            if (!isValid) {
                return;
            }

            // Proceed with saving the template if all fields are valid
            const templateData = {
                id: $('#templateId').val() || 0,
                title: $('#title').val().trim(),
                description: $('#description').val().trim(),
                topic: $('#topic').val().trim(),
                imageUrl: $('#imageUrl').val().trim(),
                isPublic: $('#isPublic').is(':checked'),
                questions: questions
            };

            $.ajax({
                url: '/User/SaveTemplate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(templateData),
                success: function(response) {
                    if (response.success) {
                        $('#templateModal').modal('hide');
                        templateTable.setData();
                        toastr.success(response.message);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function() {
                    toastr.error('An error occurred while saving the template');
                }
            });
        }

        function editTemplate(id) {
            $.get(`/User/GetTemplate/${id}`, function(template) {
                if (template.success === false) {
                    toastr.error(template.message);
                    return;
                }

                $('#templateId').val(template.id);
                $('#title').val(template.title);
                $('#description').val(template.description);
                $('#topic').val(template.topic);
                $('#imageUrl').val(template.imageUrl);
                $('#isPublic').prop('checked', template.isPublic);

                $('#questionsList').empty();
                template.questions.forEach(function(question) {
                    const questionHtml = `
                        <div class="question-item border p-3 mb-2 position-relative">
                            <button type="button" class="btn position-absolute top-0 end-0 m-2" onclick="this.parentElement.remove()">
                                <i class="bi bi-trash3"></i>
                            </button>
                            <div class="mb-2">
                                <label class="form-label">Question Title</label>
                                <input type="text" class="form-control question-title" value="${question.title}" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control question-description" value="${question.description}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Type</label>
                                <select class="form-control question-type" required>
                                    <option value="SingleLine" ${question.type === 'SingleLine' ? 'selected' : ''}>Single Line Text</option>
                                    <option value="MultiLine" ${question.type === 'MultiLine' ? 'selected' : ''}>Multi Line Text</option>
                                    <option value="Integer" ${question.type === 'Integer' ? 'selected' : ''}>Integer</option>
                                    <option value="Radio" ${question.type === 'Radio' ? 'selected' : ''}>Radio</option>
                                </select>
                            </div>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input question-show-table" ${question.showInTable ? 'checked' : ''}>
                                <label class="form-check-label">Show in Table</label>
                            </div>
                        </div>
                    `;
                    $('#questionsList').append(questionHtml);
                });

                $('#templateModalTitle').text('Edit Template');
                $('#templateModal').modal('show');
            }).fail(function() {
                toastr.error('An error occurred while loading the template.');
            });
        }



        function viewTemplateQuestions(id) {
            window.location.href = `/User/ViewTemplateQuestions/${id}`;
        }




       function deleteTemplate(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/User/DeleteTemplate/${id}`,
                        type: 'POST',  // Make sure the HTTP method matches the controller's action
                        success: function(response) {
                            templateTable.setData();
                            Swal.fire('Deleted!', response.message, 'success');
                        },
                        error: function() {
                            Swal.fire('Error!', 'An error occurred while deleting the template', 'error');
                        }
                    });
                }
            });
        }


        function viewForm(id) {
            window.location.href = `/User/ViewForm/${id}`;
        }

        function deleteForm(id) {
            if (confirm('Are you sure you want to delete this form?')) {
                $.ajax({
                    url: `/User/DeleteForm/${id}`,
                    type: 'DELETE',
                    success: function(response) {
                        formTable.setData();
                        toastr.success(response.message);
                    },
                    error: function() {
                        toastr.error('An error occurred while deleting the form');
                    }
                });
            }
        }
    </script>
}
